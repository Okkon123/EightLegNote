## 主从复制
![[2b7231b6aabb9a9a2e2390ab3a280b2d-20230309232920063.webp]]
### 第一次同步
![[ea4f7e86baf2435af3999e5cd38b6a26.webp]]第二阶段为了保证主从一致性，**主服务器在下面三个时间间隙中收到的写操作将写到replication buffer缓冲区中**
1. 主服务器生成RDB文件期间
2. 主服务器发送RDB文件给从服务器期间
3. 从服务器加载RDB服务器期间

### 命令传播
![[03eacec67cc58ff8d5819d0872ddd41e.webp]]

### 分摊主服务器的压力
![[4d850bfe8d712d3d67ff13e59b919452.webp]]
### 增量复制
![[e081b470870daeb763062bb873a4477e.webp]]
repl_backlog_buffer：环形缓冲区，记录操作
master_repl_offerset：主节点记录在repl_backlog_buffer中写到的位置
slave_repl_offset：从节点记录在repl_backlog_buffer中读到的位置

如果从节点读取的数据在repl_backlog_buffer中，则采用增量同步的方式。否则采取全量同步的方式。
![[2db4831516b9a8b79f833cf0593c1f12.webp]]

### 面试题
#### Redis主从连接是长连接还是短连接
长连接
#### 如何判断Redis摸个节点是否正常工作
ping-pong心跳检测机制

#### 主从复制架构过期key如何处理
主节点删除了一个key时，主节点会模拟一条del命令发送给从节点。从节点收到后进行删除key的操作。

#### Redis是同步复制还是异步复制
异步复制。
Redis主节点每次收到写命令后，先写到内部的缓冲区，然后异步发送给从节点。

#### replication buffer 和 repl backlog buffer有什么区别
出现阶段不一样：
1. repl backlog buffer 出现在增量复制阶段，一个主节点只有一个repl backlog buffer
2. replication buffer在全量复制阶段和增量复制阶段都出现，主节点给每一个从节点分配一个replication buffer

buffer满后处理不一样
1. repl backlog buffer是环形结构，直接覆盖起始位置
2. replication buffer满，断开连接，重新开始全量复制。
#### 主从不一致处理方法
**主从节点间的命令复制是异步进行的**
应对方法：
1. 保证主从节点间网络良好。
2. 开发外部程序监控主从节点间复制进度。
#### 主从切换如何减少数据丢失
数据丢失情况：
1. 异步复制同步丢失
2. 集群产生脑裂数据丢失

异步复制同步丢失解决方案：
1. 对于服务端：调节min-slaves-max-lag，当从节点复制同步数据延迟超过了min-slaves-max-lag时，主节点拒绝所有请求。
2. 对于客户端：当master不可写后，采取降级措施，将数据暂时存在本地缓存和磁盘中。

脑裂数据丢失解决方案：
1. min-slaves-to-write x，设置主节点至少有x个从节点连接
2. min-slaves-max-lag x，设置主从数据赋值和同步延迟不超过x秒
#### 主从如何做到故障自动切换
哨兵机制

## 哨兵
### 哨兵机制工作原理
![[775865f6bd894dfba8d373ee54d79af1.webp]]
### 如何判断主节点真的故障了
![[13e4361407ba46979e802eaa654dcf67.webp]]
主观下线 -> 客观下线

### 由哪个哨兵进行故障转移
哪个哨兵节点判断主节点为客观下线，哪个哨兵节点为候选者。
然后进行投票，哨兵只有一票，只有候选者可以投给自己。
成为leader条件：
1. 拿到半数以上赞成票
2. 拿到的票数需要大于等于哨兵配置文件中的quorum值。

### 主从故障转移过程
![[主从故障转移.webp]]
![[选主过程.webp]]
![[哨兵频道.webp]]
客户端和哨兵建立连接后，客户端会订阅哨兵提供的频道。**主从切换完成后，哨兵就会向 `+switch-master` 频道发布新主节点的 IP 地址和端口的消息，这个时候客户端就可以收到这条信息，然后用这里面的新主节点的 IP 地址和端口进行通信了**。

### 哨兵集群如何组成
![[a6286053c6884cf58bf397d01674fe80.webp]]
通过 Redis 的发布者/订阅者机制，哨兵之间可以相互感知，然后组成集群，同时，哨兵又通过 INFO 命令，在主节点里获得了所有从节点连接信息，于是就能和从节点建立连接，并进行监控了。